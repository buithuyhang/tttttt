@{
    ViewBag.Title = "BÁO CÁO HOẠT ĐỘNG BẾN";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="panel panel-info">
    <div class="panel-heading text-center">
        <h3 class="panel-title" id="plTitle_Ben"></h3>
    </div>
    <div class="panel-body">
        <div id="body_dau">
            <div class="row">                
                <div class="col-lg-10 col-md-10 col-sm-12 col-xs-12">
                    <span class="col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding-left:0px; padding-right:5px; text-align:right;">SỞ:</span>
                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                        <input id="cbbSo_BaoCaoHoatDongBen" class="input-group" style="width:100%; max-width:100000px;" />
                    </div>                     
                    <span class="col-lg-1 col-md-1 col-sm-1 col-xs-1" style="padding-left:0px; padding-right:5px; text-align:right;">TỪ:</span>
                    <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                        <input id="datepicker_BaoCaoHoatDongBen" class="input-group" style="width:100%; max-width:100000px;">
                    </div>
                    <span class="col-lg-1 col-md-1 col-sm-1 col-xs-1" style="padding-left:0px; padding-right:5px; text-align:right;">ĐẾN:</span>
                    <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                        <input id="datepicker_BaoCaoHoatDongBen1" class="input-group" style="width:100%; max-width:100000px;">
                    </div>
                    <div class="col-lg-1 col-md-1 col-sm-11 col-xs-10">
                        <button class="btn btn-primary input-group" id="btnXemBieuDoChayXe_Ben" style="width:100%;">XEM</button>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12" style="text-align: right;">
                    <div class="col-lg-0 col-md-0 col-sm-1 col-xs-2"></div>
                    <div class="col-lg-12 col-md-12 col-sm-11 col-xs-10">
                        <input type="search" id="txtSearch_BaoCaoHoatDong_Ben" class="k-textbox" style="width:100%;  max-width:100000px;" placeholder="Tìm Kiếm" />
                    </div>
                </div>                                               
            </div>
            <div class="row" style="margin-top:5px;">
                <div class="col-lg-10 col-md-10 col-sm-12 col-xs-12">
                    <span class="col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding-left:0px; padding-right:5px; text-align:right;">BẾN:</span>
                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                        <input id="cbbBen_BaoCaoHoatDongBen" class="input-group" style="width:100%; max-width:100000px;">
                    </div>                                      
                    <span class="col-lg-1 col-md-1 col-sm-1 col-xs-1" style="padding-left:0px; padding-right:5px; text-align:right;">TUYẾN:</span>
                    <div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">
                        @*<input id="cbbTuyen_BaoCaoHoatDongBen" class="input-group" style="width:100%; max-width:100000px;">*@
                        <!--NHIỀU TUYẾN-->
                        <input id="fabric" placeholder="CHỌN TUYẾN..." style="width:100%; max-width:100000px;">
                        <input id="hf_fabric" type="hidden">
                        <input id="hf_fabricc" type="hidden">
                    </div>                    
                </div>           
            </div>            
            <hr style="margin-bottom:10px;margin-top:10px;" />
            <div class="row" style="padding-bottom:5px;">
                <span>ĐÃ CHỌN : </span>
                <span id="spanfabric" style="font-weight:bold;">0</span><span> TUYẾN</span><span id="chitietchon" style="font-weight:bold;"></span>
            </div>
            <div class="row" style="padding-bottom:5px;">
                <span> TÊN BẾN:</span>
                <strong> <span id="sp_TENBEN_Search"></span> </strong>
                <span> | ĐỊA CHỈ:</span>
                <strong> <span id="sp_DIACHI_Search"><a></a></span></strong>
                <span> | SỐ ĐIỆN THOẠI:</span>
                <strong> <span id="sp_SDT_Search"><a></a></span></strong>
                <span> | TỔNG DIỆN TÍCH:</span>
                <strong> <span id="sp_TONGDIENTICH_Search"><a></a></span></strong>
            </div>
            <div class="row" style="padding-bottom:5px;">
                <span> SỐ ĐƠN VỊ HOẠT ĐỘNG:</span>
                <strong> <span id="sp_SODONVIHOATDONG_Search"></span> </strong>
                <span> | SỐ TUYẾN HOẠT ĐỘNG:</span>
                <strong> <span id="sp_SOTUYENHOATDONG_Search"><a></a></span></strong>
                <span> | CÔNG SUẤT:</span>
                <strong> <span id="sp_CONGSUAT_Search"><a></a></span></strong>
            </div>
        </div>
    </div>
    <div id="grid_BaoCaoHoatDongBen"></div>
</div>

@section scripts{
    <script src="~/Scripts/BaoCao/gridKendo.js"></script>
    <!--SET TEXT CHI TIẾT BẾN-->
    <script>
        function SetTextChiTietBen(obj){
            $("#sp_TENBEN_Search").html(obj.TenBenXe);
            $("#sp_DIACHI_Search").html(obj.DiaChi);
            $("#sp_SDT_Search").html(obj.SDT);
            $("#sp_TONGDIENTICH_Search").html(obj.TongDienTich);
            $("#sp_SODONVIHOATDONG_Search").html(obj.SoDonViHoatDong);
            $("#sp_SOTUYENHOATDONG_Search").html(obj.SoTuyenHoatDong);
            $("#sp_CONGSUAT_Search").html(obj.CongSuat);
        }        
    </script>
    <!--SET TUYẾN-->
    <script>
        function SetTextChonTuyen(obj){
            $("#sp_TUYEN_Search").html(obj.Tuyen);
        }
    </script>
    <!--DataSource-->
    <script>
    var danhsach_So = @Html.Raw(Json.Encode(ViewBag.List_So)); //console.log(danhsach_So);
    var danhsach_Ben = @Html.Raw(Json.Encode(ViewBag.List_Ben)); //console.log(danhsach_Ben);
    var danhsach_Tuyen = @Html.Raw(Json.Encode(ViewBag.List_Tuyen)); //console.log(danhsach_Tuyen);

    var dataBien_Ben = @Html.Raw(Json.Encode(ViewBag.BienCuaBen)); //console.log(dataBien_Ben);
    var data_ThongTinBen = @Html.Raw(Json.Encode(ViewBag.ThongTinBenTheoID)); //console.log(data_ThongTinBen);
    </script>
    <script>
        $(window).resize(function () {
            var gridElement = $("#grid_BaoCaoHoatDongBen");
            otherElementsHeightThongTinXe = $("#body_dau").height() + $(".navbar-static-top").height();
            gridElement.children(".k-grid-content").height($(window).height() - otherElementsHeightThongTinXe + 100);
        });
    </script>
    <!--DateTime-->
    <script>    
    $("#datepicker_BaoCaoHoatDongBen").kendoDatePicker({
        dateInput: true,
        format: "dd/MM/yyyy",
        culture: "vi-VN",
        value: kendo.parseDate(new Date()),
    });
    $("#datepicker_BaoCaoHoatDongBen1").kendoDatePicker({
        dateInput: true,
        format: "dd/MM/yyyy",
        culture: "vi-VN",
        value: kendo.parseDate(new Date()),
    });    
    var today = kendo.parseDate(new Date(dataBien_Ben.Nam, dataBien_Ben.Thang -1, dataBien_Ben.Ngay), 'dd/MM/yyyy');
    var today1 = kendo.parseDate(new Date(dataBien_Ben.Nam1, dataBien_Ben.Thang1 -1, dataBien_Ben.Ngay1), 'dd/MM/yyyy');
    var datepicker_ThangNam = $("#datepicker_BaoCaoHoatDongBen").data('kendoDatePicker');
    var datepicker1_ThangNam = $("#datepicker_BaoCaoHoatDongBen1").data('kendoDatePicker');
    datepicker_ThangNam.value(today);
    datepicker1_ThangNam.value(today1);  
    </script>

    <!--ComBoBox DropDownList-->
    <script>
        $("#cbbSo_BaoCaoHoatDongBen").kendoComboBox({
            dataTextField: "TS_TenTinh",
            dataValueField: "TS_IdTinh_So",
            dataSource: {
                data: danhsach_So,
                sort: { field: "TS_IdTinh_So", dir: "asc" }
            },
            filter: "contains",
            suggest: true,
            index: 0
        });

        $("#cbbBen_BaoCaoHoatDongBen").kendoComboBox({
            dataTextField: "TenBenXe",
            dataValueField: "BX_IdBenXe",
            dataSource: {
                data: danhsach_Ben,
                sort: { field: "BX_IdBenXe", dir: "asc" }
            },
            filter: "contains",
            suggest: true,
            index: 0,
            //dataBound: onDataBound
        });
        //$("#cbbTuyen_BaoCaoHoatDongBen").kendoComboBox({
        //    dataTextField: "TuyenDuong",
        //    dataValueField: "LT_IdLuongTuyen",
        //    dataSource: {
        //        data: danhsach_Tuyen,
        //        sort: { field: "LT_IdLuongTuyen", dir: "asc" }
        //    },
        //    filter: "contains",
        //    suggest: true,
        //    index: 0
        //});     
        $("#fabric").kendoDropDownList({
            name: "fabric",
            dataTextField: "TuyenDuong",
            dataValueField: "LT_IdLuongTuyen",
            dataSource: danhsach_Tuyen,
            filter: "contains",
            suggest: true,
            template: "<input type='checkbox' id='chk_fabric_#=data.LT_IdLuongTuyen #' onclick='UpdateIdinHF(this);' value='#=data.LT_IdLuongTuyen #' name='fabric' />" + "<label>" + "${ data.TuyenDuong }"+"</label>",
            close: onClose,
            change: onChange
        });
        $('input[id*="chk_"]').each(function () {
            $(this).prop("checked", true); 
            var hf = $("#hf_fabric").get(0);
            UpdateIdInHiddenField(hf, $(this).val(), true);
        });
        var combobox2_So = $("#cbbSo_BaoCaoHoatDongBen").data("kendoComboBox");
        var combobox_Ben = $("#cbbBen_BaoCaoHoatDongBen").data("kendoComboBox");
        //var combobox1_Tuyen = $("#cbbTuyen_BaoCaoHoatDongBen").data("kendoComboBox");
        combobox2_So.value(dataBien_Ben.So);
        combobox_Ben.value(dataBien_Ben.Ben);
        //combobox1_Tuyen.value(dataBien_Ben.Tuyen);        
        //SetText function
        SetTextChiTietBen(data_ThongTinBen);
        $("#spanfabric").html(dataBien_Ben.Tuyen);
    </script>
    <!--Loại Báo Cáo-->
    <script>
        Panel_Title("plTitle_Ben", "BÁO CÁO HOẠT ĐỘNG BẾN", "BÁO CÁO TỔNG HỢP");
        var datatest = @Html.Raw(Json.Encode(ViewBag.BaoCaoTongHop_Ben));
        console.log(datatest);
        BaoCaoHoatDong_BaoCaoTongHop_BaoCaoBen("grid_BaoCaoHoatDongBen", datatest);
        removeitemperpage();
    </script>
    <!--Search Event-->
<script>
    $("#txtSearch_BaoCaoHoatDong_Ben").keyup(function () {
        var selecteditem = $('#txtSearch_BaoCaoHoatDong_Ben').val();
        var kgrid = $("#grid_BaoCaoHoatDongBen").data("kendoGrid");
        selecteditem = selecteditem.toUpperCase();
        var selectedArray = selecteditem.split(" ");
        if (selecteditem) {
            //kgrid.dataSource.filter({ field: "UserName", operator: "eq", value: selecteditem });
            var orfilter = { logic: "or", filters: [] };
            var andfilter = { logic: "and", filters: [] };
            $.each(selectedArray, function (i, v) {
                if (v.trim() == "") {
                }
                else {
                    $.each(selectedArray, function (i, v1) {
                        var lengthStr = selecteditem.length;
                        var strBS = "";
                        if(lengthStr > 3 && lengthStr < 10 && selecteditem[3] != '-'){
                            strBS = [selecteditem.slice(0, 3), "-", selecteditem.slice(3)].join('');
                        } else {
                            strBS = v1;
                        }

                        if (v1.trim() == "") {
                        } else {
                            orfilter.filters.push({ field: "TenTuyen", operator: "contains", value: v1 },
                                                   { field: "LT_MaTuyen", operator: "contains", value: v1 } 
                                                    );
                            andfilter.filters.push(orfilter);
                            orfilter = { logic: "or", filters: [] };
                        }
                    });
                }
            });
            kgrid.dataSource.filter(andfilter);
        }
        else {
            kgrid.dataSource.filter({});
        }
    });
</script>
    <!--Ajax Combobox Sở - Bến - Tuyến-->
    <script>
    $("#cbbSo_BaoCaoHoatDongBen").on("change", function(){
        var SO = $("#cbbSo_BaoCaoHoatDongBen").data("kendoComboBox");
        var IdSO = SO.value();
        var options = {
            type: "POST",
            url: @Html.Raw(Json.Encode(Url.Action("GetBaoCaoHoatDongBen_SoRaBen", "BaoCaoHoatDong"))),
                data:
                    {
                        idso: IdSO
                    },
                cache: false,
                dataType: "json",
                //contentType: "application/json; charset=utf-8",
                success: function (response) {
                    var BEN = $("#cbbBen_BaoCaoHoatDongBen").data("kendoComboBox");
                    console.log(response);
                    if (response != null && response.length != 0) {
                        //setText function
                        dataGrid = new kendo.data.DataSource({
                            data: response,
                        });
                        BEN.setDataSource(dataGrid);
                        BEN.dataSource.read();
                        BEN.refresh();BEN.value(response[0].BX_IdBenXe);       
                        //============================================//
                        var options1 = {
                            type: "POST",
                            url: @Html.Raw(Json.Encode(Url.Action("GetBaoCaoHoatDongBen_ChonBen_RaTuyen", "BaoCaoHoatDong"))),
                            data:
                                {
                                    idben: response[0].BX_IdBenXe
                                },
                            cache: false,
                            dataType: "json",
                            //contentType: "application/json; charset=utf-8",
                            success: function (response1) {
                                if (response1 != null && response1.length != 0) {
                                    $('input[id*="chk_"]:checked').each(function () {
                                        $(this).remove();
                                    });
                                    $("#hf_fabric").val("");
                                    console.log(response1);
                                    $("#fabric").kendoDropDownList({
                                        name: "fabric",
                                        dataTextField: "TuyenDuong",
                                        dataValueField: "LT_IdLuongTuyen",
                                        dataSource: response1.ListTraVe,
                                        filter: "contains",
                                        suggest: true,
                                        template: "<input type='checkbox' id='chk_fabric_#=data.LT_IdLuongTuyen #' onclick='UpdateIdinHF(this);' value='#=data.LT_IdLuongTuyen #' name='fabric' />" + "<label>" + "${ data.TuyenDuong }"+"</label>",
                                        close: onClose,
                                        change: onChange,
                                    });
                                    SetTextChiTietBen(response1.ThongTinBen);
                                }                    
                            }
                        };
                        $.ajax(options1);
                    }else{
                        var response1 = [{
                            BX_IdBenXe : -2,
                            TenBenXe : "Không Có",
                        }];
                        dataGrid = new kendo.data.DataSource({
                            data: response1,
                        });
                        BEN.setDataSource(dataGrid);
                        BEN.dataSource.read();
                        BEN.refresh();BEN.value(response1[0].BX_IdBenXe);
                        //============================================//
                        var options1 = {
                            type: "POST",
                            url: @Html.Raw(Json.Encode(Url.Action("GetBaoCaoHoatDongBen_ChonBen_RaTuyen", "BaoCaoHoatDong"))),
                            data:
                                {
                                    idben: response1[0].BX_IdBenXe
                                },
                            cache: false,
                            dataType: "json",
                            //contentType: "application/json; charset=utf-8",
                            success: function (response1) {
                                if (response1 != null && response1.length != 0) {
                                    $('input[id*="chk_"]:checked').each(function () {
                                        $(this).remove();
                                    });
                                    $("#hf_fabric").val("");
                                    console.log(response1);
                                    $("#fabric").kendoDropDownList({
                                        name: "fabric",
                                        dataTextField: "TuyenDuong",
                                        dataValueField: "LT_IdLuongTuyen",
                                        dataSource: response1.ListTraVe,
                                        filter: "contains",
                                        suggest: true,
                                        template: "<input type='checkbox' id='chk_fabric_#=data.LT_IdLuongTuyen #' onclick='UpdateIdinHF(this);' value='#=data.LT_IdLuongTuyen #' name='fabric' />" + "<label>" + "${ data.TuyenDuong }"+"</label>",
                                        close: onClose,
                                        change: onChange,
                                    });
                                    SetTextChiTietBen(response1.ThongTinBen);
                                }                    
                            }
                        };
                        $.ajax(options1);
                    }                    
                }
            };
            $.ajax(options);
        });
        $("#cbbBen_BaoCaoHoatDongBen").on("change", function(){
            var BEN = $("#cbbBen_BaoCaoHoatDongBen").data("kendoComboBox");
            var IdBEN = BEN.value();
            var options = {
                type: "POST",
                url: @Html.Raw(Json.Encode(Url.Action("GetBaoCaoHoatDongBen_ChonBen_RaTuyen", "BaoCaoHoatDong"))),
                data:
                    {
                        idben: IdBEN
                    },
                cache: false,
                dataType: "json",
                //contentType: "application/json; charset=utf-8",
                success: function (response) {
                    if (response != null && response.length != 0) {
                        $('input[id*="chk_"]:checked').each(function () {
                            $(this).remove();
                        });
                        $("#hf_fabric").val("");
                        console.log(response);
                        console.log(IdBEN);
                        $("#fabric").kendoDropDownList({
                            name: "fabric",
                            dataTextField: "TuyenDuong",
                            dataValueField: "LT_IdLuongTuyen",
                            dataSource: response.ListTraVe,
                            filter: "contains",
                            suggest: true,
                            template: "<input type='checkbox' id='chk_fabric_#=data.LT_IdLuongTuyen #' onclick='UpdateIdinHF(this);' value='#=data.LT_IdLuongTuyen #' name='fabric' />" + "<label>" + "${ data.TuyenDuong }"+"</label>",
                            close: onClose,
                            change: onChange,
                        });
                        SetTextChiTietBen(response.ThongTinBen);
                        $('input[id*="chk_"]').each(function () {
                            $(this).prop("checked", true); 
                            var hf = $("#hf_fabric").get(0);
                            UpdateIdInHiddenField(hf, $(this).val(), true);
                        });
                    }                    
                }
            };
            $.ajax(options);
        });
    </script>
    
     <!--Event Click-->
<script>
    $('#btnXemBieuDoChayXe_Ben').on('click', function () {
        var name = "a";
        var NgayBatDau = kendo.toString($("#datepicker_BaoCaoHoatDongBen").data('kendoDatePicker').value(), "dd");
        var ThangBatDau = kendo.toString($("#datepicker_BaoCaoHoatDongBen").data('kendoDatePicker').value(), "MM");
        var NamBatDau = kendo.toString($("#datepicker_BaoCaoHoatDongBen").data('kendoDatePicker').value(), "yyyy");
        var NgayKetThuc = kendo.toString($("#datepicker_BaoCaoHoatDongBen1").data('kendoDatePicker').value(), "dd");
        var ThangKetThuc = kendo.toString($("#datepicker_BaoCaoHoatDongBen1").data('kendoDatePicker').value(), "MM");
        var NamKetThuc = kendo.toString($("#datepicker_BaoCaoHoatDongBen1").data('kendoDatePicker').value(), "yyyy");        
        var dtt1 = NgayBatDau + "/" + ThangBatDau + "/" + NamBatDau;
        var dtt2 = NgayKetThuc + "/" + ThangKetThuc + "/" + NamKetThuc;
        var SO = $("#cbbSo_BaoCaoHoatDongBen").data("kendoComboBox");
        var IdSO = SO.value(); //console.log(IdSO);
        var Ben = $("#cbbBen_BaoCaoHoatDongBen").data("kendoComboBox");
        var IdBen = Ben.value(); //console.log(IdBen);

        var nhieutuyen = $("#hf_fabric").val();
        //console.log(nhieutuyen);
        var options = {
            type: "POST",
            url: @Html.Raw(Json.Encode(Url.Action("GetBaoCaoHoatDongben_NhieuTuyen", "BaoCaoHoatDong"))),
            data: 
                {
                    name: name,  
                    so: IdSO, 
                    ben: IdBen, 
                    dt1: dtt1, 
                    dt2: dtt2, 
                    tuyen:nhieutuyen 
                },
            cache: false,
            dataType: "json",
            success: function (response) {
                console.log(response);
                if (response != null) {
                    //setText function
                    SetTextChiTietBen(response.ThongTinBen);
                    var grid = $("#grid_BaoCaoHoatDongBen").data("kendoGrid");
                    dataGrid = new kendo.data.DataSource({
                        data: response.ListTraVe,
                        pageSize: 100,
                        aggregate: [
                            { field: "LT_MaTuyen", aggregate: "count" },
                            { field: "TenTuyen", aggregate: "count" },
                            { field: "LT_CuLy", aggregate: "sum" },
                            { field: "TongSoDonVi", aggregate: "sum" },
                            { field: "SoChuyenQuyHoach", aggregate: "sum" },
                            { field: "SoChuyenKeHoach", aggregate: "sum" },
                            { field: "SoChuyenThucHien", aggregate: "sum" },
                            { field: "SoLuotKhach", aggregate: "sum" },
                            { field: "TyLeXuatBen", aggregate: "average" },
                        ]
                    });
                    grid.setDataSource(dataGrid);
                    grid.dataSource.read();
                    grid.dataSource.sort({field: "LT_IdLuongTuyen", dir: "asc"});
                    grid.refresh();
                    //console.log(response.BienToanQuoc.Tuyen);
                    if(response.BienToanQuoc.Tuyen == "Tất Cả"){
                        $("#spanfabric").html("Tất Cả");
                        $("#chitietchon").html("");
                    }else{
                        $("#spanfabric").html(response.BienToanQuoc.Tuyen);
                    }
                }
            }
        };
        $.ajax(options);
    });
</script>
    <!--Event Change-->
    @*<script>
        $("#fabric").on('change', function(){
            var text = $("#chitietchon").val();
            if(text.indexOf("Tất Cả") > - 1){
                $("#chitietchon").html();
            }else{
                $("#chitietchon").html(text);
            }
        });
    </script>*@
}